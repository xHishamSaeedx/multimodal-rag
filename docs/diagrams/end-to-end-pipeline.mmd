flowchart TB
    subgraph Ingestion["INGESTION PHASE"]
        RawData["Raw Data Sources<br/>(PDF, DOCX, PPTX, HTML, CSV, Images)"]
        Connectors["Ingestion Connectors<br/>(Confluence, Jira, S3)"]
        
        TextExtract["Text Extraction<br/>(PyMuPDF/Tika)"]
        TableExtract["Table Extraction<br/>(Camelot/Tabula)"]
        ImageExtract["Image Processing<br/>(CLIP/OCR/BLIP)"]
    end

    subgraph Processing["PROCESSING PHASE"]
        Chunking["Structured Chunking<br/>(text/table/image)"]
        Metadata["Metadata Assignment<br/>(source, ACLs, tags)"]
        
        DenseEmbed["Dense Embeddings (Vectors)<br/>Qdrant / Weaviate / Milvus"]
        SparseIndex["Sparse Index<br/>(BM25/Elastic)"]
        
        KG["Knowledge Graph Construction<br/>(Entities, Relations, Versions)"]
    end

    subgraph Query["QUERY PHASE"]
        QueryRouter["Query Router<br/>+ Query Rewriter"]
        
        SparseRet["Sparse Retriever"]
        DenseRet["Dense Retriever"]
        MetadataFilter["Metadata Filters"]
        
        CandidateMerger["Candidate Merger"]
        Reranker["Reranker"]
        Fusion["Multimodal Fusion"]
        AnswerGen["Answer Generation (LLM)<br/>(Citations, Evidence Check, Validation)"]
        Response["Final Response"]
    end

    subgraph MLOps["MLOPS (BACKBONE)"]
        MLflow["MLflow/W&B<br/>(experiments, models, prompts)"]
        DVC["DVC/LakeFS<br/>(data versioning)"]
        Airflow["Airflow/Prefect<br/>(pipelines: ingestion, index refresh, KG updates)"]
        K8s["Docker + Kubernetes<br/>(deployment)"]
        Monitoring["Monitoring<br/>(Prometheus + Grafana)"]
        Eval["Continuous evaluation<br/>(retrieval quality, hallucinations)"]
    end

    %% Ingestion flow
    RawData --> Connectors
    Connectors --> TextExtract
    Connectors --> TableExtract
    Connectors --> ImageExtract
    
    TextExtract --> Chunking
    TableExtract --> Chunking
    ImageExtract --> Chunking
    
    TextExtract --> Metadata
    TableExtract --> Metadata
    ImageExtract --> Metadata
    
    %% Processing flow
    Chunking --> DenseEmbed
    Chunking --> SparseIndex
    Metadata --> DenseEmbed
    Metadata --> SparseIndex
    
    DenseEmbed -.->|Optional| KG
    SparseIndex -.->|Optional| KG
    
    %% Query flow
    QueryRouter --> SparseRet
    QueryRouter --> DenseRet
    QueryRouter --> MetadataFilter
    
    SparseRet --> CandidateMerger
    DenseRet --> CandidateMerger
    MetadataFilter --> CandidateMerger
    
    CandidateMerger --> Reranker
    Reranker --> Fusion
    Fusion --> AnswerGen
    AnswerGen --> Response
    
    %% Storage connections
    SparseRet -.->|reads| SparseIndex
    DenseRet -.->|reads| DenseEmbed
    MetadataFilter -.->|reads| Metadata
    Fusion -.->|reads| KG
    
    %% MLOps connections
    MLflow -.->|tracks| AnswerGen
    DVC -.->|versions| RawData
    Airflow -.->|orchestrates| Connectors
    Airflow -.->|orchestrates| DenseEmbed
    Airflow -.->|orchestrates| SparseIndex
    Airflow -.->|orchestrates| KG
    K8s -.->|deploys| QueryRouter
    Monitoring -.->|monitors| AnswerGen
    Eval -.->|evaluates| Reranker

    %% Styling
    classDef ingestion fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef processing fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef query fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef mlops fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef optional fill:#fff9c4,stroke:#f57f17,stroke-width:2px,stroke-dasharray: 5 5

    class RawData,Connectors,TextExtract,TableExtract,ImageExtract ingestion
    class Chunking,Metadata,DenseEmbed,SparseIndex processing
    class QueryRouter,SparseRet,DenseRet,MetadataFilter,CandidateMerger,Reranker,Fusion,AnswerGen,Response query
    class DenseEmbed,SparseIndex,KG storage
    class MLflow,DVC,Airflow,K8s,Monitoring,Eval mlops
    class KG optional

