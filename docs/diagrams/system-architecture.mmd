flowchart TB
    subgraph Frontend[" "]
        UI1["FRONTEND UI<br/>Web App / Dashboard / Chat UI<br/>Query Input + File Uploads"]
        UI2["FRONTEND UI<br/>Answer, Sources, Images, Graphs"]
    end

    subgraph Backend[" "]
        API1["BACKEND API<br/>(FastAPI / Node / Gateway)<br/>---<br/>- Auth & ACL checks<br/>- Query Router & Rewriter<br/>- Orchestrates Hybrid RAG Pipeline<br/>- Calls microservices below"]
        API2["Backend API Response"]
    end

    subgraph Services[" "]
        Sparse["Sparse Search<br/>(BM25 / ES)"]
        Dense["Dense Embedding Svc<br/>(Text/Table/Image)"]
        Image["Image/Table/OCR Svc<br/>(CLIP, OCR, Caption)"]
    end

    subgraph Processing[" "]
        Reranker["Reranker<br/>(Cross-encoder / LLM)"]
        Graph["(Optional) Graph Service<br/>(Entities, Relations)"]
        Fusion["Multimodal Fusion Engine<br/>(Text + Tables + Images + Graph)"]
        LLM["LLM Answer Generator<br/>(Citations, Evidence, Reasoning)"]
    end

    subgraph Storage["DATA + STORAGE LAYER"]
        VectorDB["Vector DB<br/>(Qdrant/Weaviate)"]
        BM25["BM25/Sparse Index<br/>(Elasticsearch/OpenSearch)"]
        KG["Knowledge Graph<br/>(Neo4j/Arango)"]
        Processed["Processed Docs<br/>(Postgres/Mongo)"]
        DataLake["Raw Data Lake<br/>(S3 / GCS / Azure Blob / MinIO)"]
    end

    subgraph MLOps["MLOps LAYER"]
        Registry["Model Registry (MLflow)<br/>+ Experiment Tracking"]
        Orchestrator["Pipeline Orchestrator<br/>(Airflow / Prefect)"]
        Monitoring["Monitoring (Prom+Graf)<br/>Logging + Metrics"]
        CICD["CI/CD (GitHub Actions/K8s)"]
        Retraining["Automated Retraining<br/>Evaluation + Indexing"]
        Feedback["User Feedback Loop<br/>Improves retriever/LLM"]
    end

    %% Main flow
    UI1 -->|HTTPS/REST| API1
    API1 -->|internal gRPC/REST| Sparse
    API1 -->|internal gRPC/REST| Dense
    API1 -->|internal gRPC/REST| Image
    
    Sparse --> Reranker
    Dense --> Reranker
    Image --> Graph
    Image --> Reranker
    
    Reranker --> Fusion
    Graph --> Fusion
    Fusion --> LLM
    LLM --> API2
    API2 --> UI2

    %% Storage connections
    Sparse -.->|reads| BM25
    Dense -.->|reads| VectorDB
    Image -.->|reads| VectorDB
    Graph -.->|reads| KG
    LLM -.->|reads| Processed
    
    VectorDB -.->|stores| DataLake
    BM25 -.->|stores| DataLake
    KG -.->|stores| DataLake
    Processed -.->|stores| DataLake

    %% MLOps connections
    Registry --> CICD
    Orchestrator --> Retraining
    Monitoring --> Feedback
    
    Registry -.->|manages| VectorDB
    Orchestrator -.->|orchestrates| DataLake
    Retraining -.->|updates| VectorDB
    Feedback -.->|improves| LLM

    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef processing fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef mlops fill:#fff9c4,stroke:#f57f17,stroke-width:2px

    class UI1,UI2 frontend
    class API1,API2 backend
    class Sparse,Dense,Image service
    class Reranker,Graph,Fusion,LLM processing
    class VectorDB,BM25,KG,Processed,DataLake storage
    class Registry,Orchestrator,Monitoring,CICD,Retraining,Feedback mlops

