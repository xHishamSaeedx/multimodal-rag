flowchart TB
    Query["User Query/API"]
    
    Router["Query Router &<br/>Rewriter"]
    
    Sparse["Sparse Search<br/>(BM25/ES)"]
    Dense["Dense Vector DB<br/>(Qdrant/Weaviate)"]
    Metadata["Metadata Filter<br/>(modality/ACL)"]
    
    Merger["Candidate Merger<br/>(Combine: sparse + dense + filters)"]
    
    Reranker["Reranker<br/>(Cross Encoder/LLM)"]
    
    TextChunks["Text Chunks"]
    Tables["Tables<br/>(JSON/Markdown)"]
    Images["Images/Diagrams"]
    
    GraphRetrieval["Graph Retrieval<br/>(Entities, Relations, Multi-hop Paths)"]
    
    Fusion["Multimodal Fusion<br/>(Text + Tables + Images + Graph Context)"]
    
    AnswerGen["Answer Generation (LLM)<br/>+ Citations + Validation"]
    
    Response["Final Response to User"]

    %% Main flow
    Query --> Router
    Router --> Sparse
    Router --> Dense
    Router --> Metadata
    
    Sparse --> Merger
    Dense --> Merger
    Metadata --> Merger
    
    Merger --> Reranker
    
    Reranker --> TextChunks
    Reranker --> Tables
    Reranker --> Images
    
    %% Optional path
    Reranker -.->|Optional Path| GraphRetrieval
    
    TextChunks --> Fusion
    Tables --> Fusion
    Images --> Fusion
    GraphRetrieval --> Fusion
    
    Fusion --> AnswerGen
    AnswerGen --> Response

    %% Styling
    classDef input fill:#e3f2fd,stroke:#0277bd,stroke-width:2px
    classDef routing fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef search fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef processing fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef content fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef optional fill:#fff9c4,stroke:#f57f17,stroke-width:2px,stroke-dasharray: 5 5
    classDef output fill:#e1f5ff,stroke:#01579b,stroke-width:2px

    class Query input
    class Router routing
    class Sparse,Dense,Metadata search
    class Merger,Reranker,Fusion,AnswerGen processing
    class TextChunks,Tables,Images content
    class GraphRetrieval optional
    class Response output

